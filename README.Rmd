---
output: github_document
editor_options:
  markdown:
    wrap: 72
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.path = "man/figures/")
```


# CMAversePlus: a friendly fork of CMAverse with extra g-formula options

<img src="man/figures/logo2.png" align="right" height="300" alt="CMAversePlus logo"/>

**CMAversePlus** is a small “add-on package” based on the excellent
[CMAverse](https://github.com/BS1125/CMAverse). I created this fork (see
below) for teaching, personal use, and a few specific projects. I have
tried to keep this page accessible to those who are new to R and/or GitHub.

- **CMAverse** is a widely used R package for causal mediation analysis.
- **CMAversePlus** keeps the same workflow and commands, but adds a few
  **extra options for g-computation**, specifically risk ratios / risk
  differences for binary outcomes, a more standard version of interventional effects,
  and minor labelling changes.

*A fork* is simply a copy of another package’s code that someone adapts
for their own needs. This fork is **not officially part of CMAverse** and **I am not afiliated with the original package**.
If you want the stable, fully supported version, use CMAverse itself.
If you need these specific extras, feel free to use CMAversePlus.

#### Why are these functions not part of CMAverse?

CMAversePlus was created with my own specific teaching and project needs in mind. It works well for this purpose, 
but it has not yet been fully integrated with every feature of CMAverse. Achieving that would require additional work 
and discussion with the original authors. I haven’t contacted them yet, although I may do so in future.

## What’s different? (when `model = "gformula"`)

```{r features, echo=FALSE, results='asis'}
library(knitr)

df <- data.frame(
  Feature = c(
    "Effect measures for binary outcomes",
    "Conditional mediator draws",
    "Effect labels"
  ),
  `What it does` = c(
    "Choose odds ratio (OR), risk ratio (RR), or risk difference (RD)",
    "Choose conditional vs marginal mediator draws for interventional effects",
    "Switch labels automatically between natural and interventional effects"
  ),
  `Use in` = c(
    "`cmest(model = 'gformula')`<br>Binary outcomes only",
    "`cmest(model = 'gformula')`<br>Interventional effects",
    "`cmest(model = 'gformula')`<br>Printing/summary only"
  ),
  Argument = c("`binary_scale`", "`draw_conditional`", "—"),
  Options  = c("`'OR' / 'RR' / 'RD'`", "`TRUE / FALSE`", "—"),
  Default  = c("`'OR'`", "`FALSE`", "—"),
  Recommended = c("`'RR'` or `'RD'`", "`TRUE`", "—"),
  check.names = FALSE
)

knitr::kable(
  df,
  format = "pipe",
  align  = c("l","l","l","c","c","c","c"),
  col.names = colnames(df),
  escape = FALSE
)
```

*By default, both toggles are off. If you don’t change them,
CMAversePlus behaves exactly like CMAverse.*

## New features (details)

> **Note (scope)**  
> All new options currently target **single-mediator** settings. If you
> use multiple mediators, use the original package or proceed at your own risk.

**1) Additional effect measures for binary outcomes.**  
Use `binary_scale` to choose which effects are reported under
g-computation:

- `"OR"` — odds ratio (CMAverse default)  
- `"RR"` — risk ratio  
- `"RD"` — risk difference

Risk ratios/differences are often more intuitive to interpret than odds ratios.

**2) Interventional effects via conditional draws of M.**  
Set `draw_conditional = TRUE` to compute interventional effects using a
conditional mediator draw. The CMAverse implementation uses a
marginal draw (via permutation); keeping `draw_conditional = FALSE`
preserves that behaviour.

Both approaches are valid and often yield similar results in practice. The conditional
draw is the more standard definition and often corresponds to more
sensible hypothetical interventions. It also relies on a slightly weaker
positivity condition than the marginal draw (discussed in
[Nguyen et al., 2020](https://psycnet.apa.org/doiLanding?doi=10.1037%2Fmet0000299)).

**3) Effect labels for interventional effects.**  
When `model = "gformula"`:

- If `postc` is specified, labels use the randomised-analogue
  notation (e.g., `rpnde`, and total effects are shown as `rte` / `rRte`).
- If `postc` is not specified, labels use natural effect
  notation (e.g., `pnde`, `te` / `Rte`).

Importantly, when intermediate confounding is present, the sum/product of the interventional direct and indirect effect 
is **not** the standard total effect. We label that quantity as the **randomised total effect** (`rte`) for clarity
(also known as the *overall effect*).

## Installation

```{r, eval=FALSE}
# install remotes if needed
if (!requireNamespace("remotes", quietly = TRUE)) {
  install.packages("remotes")
}

# install CMAversePlus
remotes::install_github("martindanka/CMAversePlus")
```

If you prefer not to use GitHub installs, you can download the package
archive (`.zip` / `.tar.gz`) from the repository and use
**RStudio → Tools → Install Packages… → Install from: Package Archive
File**.

## Minimal example

Tutorials on using the original CMAverse package are provided on the [official website](https://bs1125.github.io/CMAverse/). 
Below is a minimal example where the CMAversePlus toggles are applied to a simulated dataset from the 
original [CMAverse vignette](https://bs1125.github.io/CMAverse/articles/post_exposure_confounding.html). 

When you install CMAversePlus, it is recommended that you always specify wheter you want functions 
from CMAverse or CMAversePlus, e.g., use `CMAversePlus::cmest()` or `CMAverse::cmest()`rather than `cmest()`.

```{r, message = FALSE, warning = FALSE}
# Load CMAversePlus
library(CMAversePlus)
```


```{r, warning= FALSE}
# Simulate CMAverse example dataset
set.seed(1)
expit <- function(x) exp(x)/(1+exp(x))
n <- 10000
C1 <- rnorm(n, mean = 1, sd = 0.1)
C2 <- rbinom(n, 1, 0.6)
A <- rbinom(n, 1, expit(0.2 + 0.5*C1 + 0.1*C2))
L <- rnorm(n, mean = 1 + A - C1 - 0.5*C2, sd = 0.5)
M <- rbinom(n, 1, expit(1 + 2*A - L + 1.5*C1 + 0.8*C2))
Y <- rbinom(n, 1, expit(-3 - 0.4*A - 1.2*M + 0.5*A*M - 0.5*L + 0.3*C1 - 0.6*C2))
data <- data.frame(A, M, Y, C1, C2, L)
```

Now we can request interventional effects on the risk ratio scale. We will also request the conditional draw from the
mediator distribution instead of the marginal default. 

```{r}
fit <- CMAversePlus::cmest(
  data = data, 
  model = "gformula", 
  outcome = "Y", 
  exposure = "A", 
  mediator = "M", 
  basec = c("C1", "C2"), 
  postc = "L", 
  EMint = TRUE, 
  mreg = list("logistic"), 
  yreg = "logistic", 
  postcreg = list("linear"), 
  astar = 0, 
  a = 1, 
  mval = list(1), 
  estimation = "imputation", 
  inference = "bootstrap", 
  nboot = 2,
  # CMAversePlus-only toggles:
  binary_scale = "RR",
  draw_conditional = TRUE 
  )

summary(fit)
```

## Further CMAverse resources

See the CMAverse website: <https://bs1125.github.io/CMAverse/>

## Attribution

CMAversePlus is only a small addition that builds directly on CMAverse. Please **cite CMAverse** when
you use this fork. If you specifically rely on the add-ons here, you’re welcome to reference this repository as well.
